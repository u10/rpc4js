/*!
 * rpc4js v0.0.1
 * (c) 2016 Vaniship
 * Released under the MIT License.
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("lodash"),require("q"),require("node-uuid")):"function"==typeof define&&define.amd?define(["lodash","q","node-uuid"],r):e.rpc4js=r(e._,e.Q,e.uuid)}(this,function(e,r,n){"use strict";function t(r,i,o,u,a,f){if(a=a||[],!e.isFunction(r)){if(e.isArray(r)){for(var l=[],d=0,s=r.length;d<s;d++)a.push(d),l.push(t(r[d],i,o,u,a)),a.pop();return l}if(e.isObject(r)){var l={};for(var v in r)a.push(v),l[v]=t(r[v],i,o,u,a,r),a.pop();return l}return r}var p=function(){var t=n.v4();return u&&u.clear&&u.clear.push(t),o[t]=function(n){return function(){var i=e.extend({},u,{clear:!1}),a=1<=arguments.length?c.call(arguments,0):[],f=r.apply(n,[i].concat(a));if(i.clear){if(u.clear){var l=!0,d=!1,s=void 0;try{for(var v,p=u.clear[Symbol.iterator]();!(l=(v=p.next()).done);l=!0){var m=v.value;delete o[m]}}catch(e){d=!0,s=e}finally{try{!l&&p.return&&p.return()}finally{if(d)throw s}}}}else i.release&&delete o[t];return f}}(f),i.push(a.concat([t])),{v:0}}();if("object"==typeof p)return p.v}function i(e,i,o,u){for(var a,f,l,d=0,s=o.length;d<s;d++){l=o[d],f=i;for(var v=0,p=l.length-2;v<p;v++)f=f[l[v]];a=l[l.length-1],f[l[l.length-2]]=function(i){return function(){var o=1<=arguments.length?c.call(arguments,0):[],a=r.defer(),f=[],l=n.v4();e.emit("rpc-call",{id:l,method:i,args:t(o,f,u,{release:!0,clear:[]}),funcIndex:f});var d=setTimeout(function(){e.removeListener("rpc-return",s),a.reject()},5e3),s=function r(n){n.id===l&&(clearTimeout(d),e.removeListener("rpc-return",r),n.error?a.reject(n.error):a.resolve(n.result))};return e.on("rpc-return",s),a.promise}}(a)}return i}function o(e,r){return function(n){var t=r[n.method];if(t)try{var o=t.apply(null,i(e,n.args,n.funcIndex,r));e.emit("rpc-return",{id:n.id,result:o})}catch(r){e.emit("rpc-return",{id:n.id,error:r})}else e.emit("rpc-return",{id:n.id,error:"function not found"})}}e="default"in e?e.default:e,r="default"in r?r.default:r,n="default"in n?n.default:n;var c=[].slice,u={},a={define:function(e,r){return u[e]=r,this},listen:function(e){this.ws=e,e.on("connect",function(e){var r={},n=[];e.on("rpc-connect",function(c){var a=u[c.name];if(a){var f=a(i(e,c.client,c.funcIndex,r));e.on("rpc-call",o(e,r)),e.emit("rpc-connect",{id:c.id,name:c.name,remote:t(f,n,r),funcIndex:n})}else e.emit("rpc-connect",{id:c.id,name:c.name,error:"object not found"})}).on("disconnect",function(){r=void 0,n=void 0})})},bind:function(e){return this.ws=e,this},connect:function(e,c){function u(){clearTimeout(s),f.removeListener("rpc-connect",p),d=void 0,l=void 0}var a=r.defer(),f=this.ws,l=[],d={},s=setTimeout(function(){u(),a.reject("timeout")},5e3),v=n.v4();f.emit("rpc-connect",{id:v,name:e,client:t(c,l,d),funcIndex:l});var p=function e(r){r.id===v&&(r.error?(u(),a.reject(r.error)):(clearTimeout(s),f.removeListener("rpc-connect",e),f.on("rpc-call",o(f,d)),a.resolve(i(f,r.remote,r.funcIndex,d))))};return f.on("rpc-connect",p),a.promise},destroy:function(){var e;e=this.ws,e.removeListener("rpc-call"),e.removeListener("rpc-return"),delete this.ws}};return a});