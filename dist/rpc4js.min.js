/*!
 * rpc4js v0.1.0
 * (c) 2016 Vaniship
 * Released under the MIT License.
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("lodash"),require("q"),require("node-uuid")):"function"==typeof define&&define.amd?define(["lodash","q","node-uuid"],n):e.rpc4js=n(e._,e.Q,e.uuid)}(this,function(e,n,t){"use strict";function r(e,n){if(n[e]){for(var t in n[e])delete n[n[e][t]];n[e]=!1,setTimeout(function(){delete n[e]},100)}}function o(e,n){for(var t in e){var r=e[t];delete n[r[r.length-1]]}}function i(r,u,c,s,a,f){if(a=a||[],!e.isFunction(r)){if(e.isArray(r)){for(var l=[],p=0,m=r.length;p<m;p++)a.push(p),l.push(i(r[p],u,c,s,a)),a.pop();return l}if(e.isObject(r)){var l={};for(var v in r)a.push(v),l[v]=i(r[v],u,c,s,a,r),a.pop();return l}return r}var h=function(){var e=t.v4();if(!s.autoRelease&&s.id){if(s.disposed||c[s.id]===!1)return{v:0};(c[s.id]=c[s.id]||[]).push(e)}return c[e]=function(){var t=n.defer(),i=1<=arguments.length?d.call(arguments,0):[];try{t.resolve(r.apply(f,i)),s.autoRelease&&delete c[e]}catch(n){t.reject({message:n.message}),s.autoRelease&&(u=o(u,c),delete c[e])}return t.promise},u.push(a.concat([e])),{v:0}}();if("object"==typeof h)return h.v}function u(u,c,s,a,f){for(var l,p,m,v=0,h=s.length;v<h;v++){m=s[v],p=c;for(var g=0,x=m.length-2;g<x;g++)p=p[m[g]];l=m[m.length-1],p[m[m.length-2]]=function(c){return function(){var s=n.defer(),l=1<=arguments.length?d.call(arguments,0):[],p=t.v4(),m=e.extend({timeout:5e3,autoRelease:!0,id:p},f),v=[];setTimeout(function(){var e=setTimeout(function(){u.removeListener("rpc-return",n),s.reject({message:"timeout"})},m.timeout),n=function n(t){t.id===p&&(clearTimeout(e),u.removeListener("rpc-return",n),t.error?(s.reject(t.error),m.autoRelease&&(v=o(v,a),delete a[c])):(s.resolve(t.result),m.autoRelease&&delete a[c]))};u.emit("rpc-call",{id:p,method:c,args:i(l,v,a,m),funcIndex:v,options:m}),u.on("rpc-return",n)},0);var h=e.extend(s.promise,{config:function(n){return e.extend(m,n),h},end:function(){m.autoRelease||(m.disposed=!0,r(p,a),u.emit("rpc-release",{id:p}))}});return h}}(l)}return c}function c(e,n){return function(t){var r=n[t.method];r?r.apply(null,u(e,t.args,t.funcIndex,n,t.options)).then(function(n){e.emit("rpc-return",{id:t.id,result:n})}).fail(function(n){e.emit("rpc-return",{id:t.id,error:n})}):e.emit("rpc-return",{id:t.id,error:{message:"function not found"}})}}function s(e){return function(n){r(n.id,e)}}e="default"in e?e.default:e,n="default"in n?n.default:n,t="default"in t?t.default:t;var d=[].slice,a={},f={define:function(e,n){return a[e]=n,this},listen:function(e){this.ws=e,e.on("connect",function(e){var n={},t=[];e.on("rpc-connect",function(r){var o=a[r.name];if(o){var d=o(u(e,r.client,r.funcIndex,n));e.on("rpc-call",c(e,n)),e.on("rpc-release",s(n)),e.emit("rpc-connect",{id:r.id,name:r.name,remote:i(d,t,n,r.options),funcIndex:t})}else e.emit("rpc-connect",{id:r.id,name:r.name,error:{message:"object not found"}})}).on("disconnect",function(){n=void 0,t=void 0})})},bind:function(e){return this.ws=e,this},connect:function(r,o,d){function a(){clearTimeout(v),l.removeListener("rpc-connect",g),m=void 0,p=void 0}d=e.extend({timeout:5e3,autoRelease:!1},d);var f=n.defer(),l=this.ws,p=[],m={},v=setTimeout(function(){a(),f.reject({message:"timeout"})},d.timeout),h=t.v4();l.emit("rpc-connect",{id:h,name:r,client:i(o,p,m,d),funcIndex:p,options:d});var g=function e(n){n.id===h&&(n.error?(a(),f.reject(n.error)):(clearTimeout(v),l.removeListener("rpc-connect",e),l.on("rpc-call",c(l,m)),l.on("rpc-release",s(m)),f.resolve(u(l,n.remote,n.funcIndex,m))))};return l.on("rpc-connect",g),e.extend(f.promise,{check:function(){console.log(m)}})},destroy:function(){var e;e=this.ws,e.removeListener("rpc-call"),e.removeListener("rpc-release"),e.removeListener("rpc-return"),delete this.ws}};return f});