/*!
 * rpc4js v0.0.1
 * (c) 2016 Vaniship
 * Released under the MIT License.
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("lodash"),require("q"),require("node-uuid")):"function"==typeof define&&define.amd?define(["lodash","q","node-uuid"],n):e.rpc4js=n(e._,e.Q,e.uuid)}(this,function(e,n,r){"use strict";function t(n,c,i,u,a,f){if(a=a||[],!e.isFunction(n)){if(e.isArray(n)){for(var l=[],d=0,s=n.length;d<s;d++)a.push(d),l.push(t(n[d],c,i,u,a)),a.pop();return l}if(e.isObject(n)){var l={};for(var p in n)a.push(p),l[p]=t(n[p],c,i,u,a,n),a.pop();return l}return n}var v=function(){var t=r.v4();return u&&u.clear&&u.clear.push(t),i[t]=function(r){return function(){var c=e.extend({},u,{clear:!1}),a=1<=arguments.length?o.call(arguments,0):[],f=n.apply(r,[c].concat(a));if(c.clear){if(u.clear){var l=!0,d=!1,s=void 0;try{for(var p,v=u.clear[Symbol.iterator]();!(l=(p=v.next()).done);l=!0){var h=p.value;delete i[h]}}catch(e){d=!0,s=e}finally{try{!l&&v.return&&v.return()}finally{if(d)throw s}}}}else c.release&&delete i[t];return f}}(f),c.push(a.concat([t])),{v:0}}();if("object"==typeof v)return v.v}function c(e,c,i,u){for(var a,f,l,d=0,s=i.length;d<s;d++){l=i[d],f=c;for(var p=0,v=l.length-2;p<v;p++)f=f[l[p]];a=l[l.length-1],f[l[l.length-2]]=function(c){return function(){var i=1<=arguments.length?o.call(arguments,0):[],a=n.defer(),f=[],l=r.v4();i=t(i,f,u,{release:!0,clear:[]}),e.emit("rpc-call",{id:l,method:c,args:i,funcIndex:f});var d=setTimeout(function(){e.removeListener("rpc-return",s),a.reject()},5e3),s=function n(r){r.id===l&&(clearTimeout(d),e.removeListener("rpc-return",n),r.error?a.reject(r.error):a.resolve(r.result))};return e.on("rpc-return",s),a.promise}}(a)}return c}function i(e,n){return function(r){var t=n[r.method];if(t){var i=c(e,r.args,r.funcIndex,n),o=t.apply(null,i);e.emit("rpc-return",{id:r.id,result:o})}else e.emit("rpc-return",{id:r.id,error:"function not found"})}}e="default"in e?e.default:e,n="default"in n?n.default:n,r="default"in r?r.default:r;var o=[].slice,u={},a={define:function(e,n){return u[e]=n,this},listen:function(e){this.ws=e,e.on("connect",function(e){var n={},r=[];e.on("rpc-connect",function(o){var a=c(e,o.client,o.funcIndex,n),f=u[o.name](a);f=t(f,r,n),e.on("rpc-call",i(e,n)),e.emit("rpc-connect",{name:o.name,remote:f,funcIndex:r})}).on("disconnect",function(){n=void 0,r=void 0})})},bind:function(e){return this.ws=e,this},connect:function(e,n,r){var o=this.ws,u={},a=[],f=t(n,a,u);o.emit("rpc-connect",{name:e,client:f,funcIndex:a});var l=function n(t){var a;t.name===e&&(o.removeListener("rpc-connect",n),o.on("rpc-call",i(o,u)),a=c(o,t.remote,t.funcIndex,u),r(a))};o.on("rpc-connect",l)},destroy:function(){var e;e=this.ws,e.removeListener("rpc-call"),e.removeListener("rpc-return"),delete this.ws}};return a});